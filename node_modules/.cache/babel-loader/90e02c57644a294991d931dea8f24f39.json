{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst React = __importStar(require(\"react\"));\n\nconst react_portal_1 = require(\"react-portal\");\n\nconst some_1 = __importDefault(require(\"lodash/some\"));\n\nconst prosemirror_state_1 = require(\"prosemirror-state\");\n\nconst tableCol_1 = __importDefault(require(\"../menus/tableCol\"));\n\nconst tableRow_1 = __importDefault(require(\"../menus/tableRow\"));\n\nconst table_1 = __importDefault(require(\"../menus/table\"));\n\nconst formatting_1 = __importDefault(require(\"../menus/formatting\"));\n\nconst image_1 = __importDefault(require(\"../menus/image\"));\n\nconst divider_1 = __importDefault(require(\"../menus/divider\"));\n\nconst FloatingToolbar_1 = __importDefault(require(\"./FloatingToolbar\"));\n\nconst LinkEditor_1 = __importDefault(require(\"./LinkEditor\"));\n\nconst ToolbarMenu_1 = __importDefault(require(\"./ToolbarMenu\"));\n\nconst filterExcessSeparators_1 = __importDefault(require(\"../lib/filterExcessSeparators\"));\n\nconst isMarkActive_1 = __importDefault(require(\"../queries/isMarkActive\"));\n\nconst getMarkRange_1 = __importDefault(require(\"../queries/getMarkRange\"));\n\nconst isNodeActive_1 = __importDefault(require(\"../queries/isNodeActive\"));\n\nconst getColumnIndex_1 = __importDefault(require(\"../queries/getColumnIndex\"));\n\nconst getRowIndex_1 = __importDefault(require(\"../queries/getRowIndex\"));\n\nconst createAndInsertLink_1 = __importDefault(require(\"../commands/createAndInsertLink\"));\n\nfunction isVisible(props) {\n  const {\n    view\n  } = props;\n  const {\n    selection\n  } = view.state;\n  if (!selection) return false;\n  if (selection.empty) return false;\n\n  if (selection.node && selection.node.type.name === \"hr\") {\n    return true;\n  }\n\n  if (selection.node && selection.node.type.name === \"image\") {\n    return true;\n  }\n\n  if (selection.node) return false;\n  const slice = selection.content();\n  const fragment = slice.content;\n  const nodes = fragment.content;\n  return some_1.default(nodes, n => n.content.size);\n}\n\nclass SelectionToolbar extends React.Component {\n  constructor() {\n    super(...arguments);\n    this.isActive = false;\n    this.menuRef = React.createRef();\n\n    this.handleClickOutside = ev => {\n      if (ev.target instanceof Node && this.menuRef.current && this.menuRef.current.contains(ev.target)) {\n        return;\n      }\n\n      if (!this.isActive) {\n        return;\n      }\n\n      const {\n        view\n      } = this.props;\n\n      if (view.hasFocus()) {\n        return;\n      }\n\n      const {\n        dispatch\n      } = view;\n      dispatch(view.state.tr.setSelection(new prosemirror_state_1.TextSelection(view.state.doc.resolve(0))));\n    };\n\n    this.handleOnCreateLink = async title => {\n      const {\n        dictionary,\n        onCreateLink,\n        view,\n        onShowToast\n      } = this.props;\n\n      if (!onCreateLink) {\n        return;\n      }\n\n      const {\n        dispatch,\n        state\n      } = view;\n      const {\n        from,\n        to\n      } = state.selection;\n\n      if (from === to) {\n        return;\n      }\n\n      const href = `creating#${title}…`;\n      const markType = state.schema.marks.link;\n      dispatch(view.state.tr.removeMark(from, to, markType).addMark(from, to, markType.create({\n        href\n      })));\n      createAndInsertLink_1.default(view, title, href, {\n        onCreateLink,\n        onShowToast,\n        dictionary\n      });\n    };\n\n    this.handleOnSelectLink = _ref => {\n      let {\n        href,\n        from,\n        to\n      } = _ref;\n      const {\n        view\n      } = this.props;\n      const {\n        state,\n        dispatch\n      } = view;\n      const markType = state.schema.marks.link;\n      dispatch(state.tr.removeMark(from, to, markType).addMark(from, to, markType.create({\n        href\n      })));\n    };\n  }\n\n  componentDidUpdate() {\n    const visible = isVisible(this.props);\n\n    if (this.isActive && !visible) {\n      this.isActive = false;\n      this.props.onClose();\n    }\n\n    if (!this.isActive && visible) {\n      this.isActive = true;\n      this.props.onOpen();\n    }\n  }\n\n  componentDidMount() {\n    window.addEventListener(\"mouseup\", this.handleClickOutside);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(\"mouseup\", this.handleClickOutside);\n  }\n\n  render() {\n    const _a = this.props,\n          {\n      dictionary,\n      onCreateLink,\n      isTemplate,\n      rtl\n    } = _a,\n          rest = __rest(_a, [\"dictionary\", \"onCreateLink\", \"isTemplate\", \"rtl\"]);\n\n    const {\n      view\n    } = rest;\n    const {\n      state\n    } = view;\n    const {\n      selection\n    } = state;\n    const isCodeSelection = isNodeActive_1.default(state.schema.nodes.code_block)(state);\n    const isDividerSelection = isNodeActive_1.default(state.schema.nodes.hr)(state);\n\n    if (isCodeSelection) {\n      return null;\n    }\n\n    const colIndex = getColumnIndex_1.default(state.selection);\n    const rowIndex = getRowIndex_1.default(state.selection);\n    const isTableSelection = colIndex !== undefined && rowIndex !== undefined;\n    const link = isMarkActive_1.default(state.schema.marks.link)(state);\n    const range = getMarkRange_1.default(selection.$from, state.schema.marks.link);\n    const isImageSelection = selection.node && selection.node.type.name === \"image\";\n    let isTextSelection = false;\n    let items = [];\n\n    if (isTableSelection) {\n      items = table_1.default(dictionary);\n    } else if (colIndex !== undefined) {\n      items = tableCol_1.default(state, colIndex, rtl, dictionary);\n    } else if (rowIndex !== undefined) {\n      items = tableRow_1.default(state, rowIndex, dictionary);\n    } else if (isImageSelection) {\n      items = image_1.default(state, dictionary);\n    } else if (isDividerSelection) {\n      items = divider_1.default(state, dictionary);\n    } else {\n      items = formatting_1.default(state, isTemplate, dictionary);\n      isTextSelection = true;\n    }\n\n    items = items.filter(item => {\n      if (item.name === \"separator\") return true;\n      if (item.name && !this.props.commands[item.name]) return false;\n      return true;\n    });\n    items = filterExcessSeparators_1.default(items);\n\n    if (!items.length) {\n      return null;\n    }\n\n    const selectionText = state.doc.cut(state.selection.from, state.selection.to).textContent;\n\n    if (isTextSelection && !selectionText) {\n      return null;\n    }\n\n    return React.createElement(react_portal_1.Portal, null, React.createElement(FloatingToolbar_1.default, {\n      view: view,\n      active: isVisible(this.props),\n      ref: this.menuRef\n    }, link && range ? React.createElement(LinkEditor_1.default, Object.assign({\n      dictionary: dictionary,\n      mark: range.mark,\n      from: range.from,\n      to: range.to,\n      onCreateLink: onCreateLink ? this.handleOnCreateLink : undefined,\n      onSelectLink: this.handleOnSelectLink\n    }, rest)) : React.createElement(ToolbarMenu_1.default, Object.assign({\n      items: items\n    }, rest))));\n  }\n\n}\n\nexports.default = SelectionToolbar;","map":{"version":3,"sources":["../../src/components/SelectionToolbar.tsx"],"names":[],"mappings":"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","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst React = __importStar(require(\"react\"));\nconst react_portal_1 = require(\"react-portal\");\nconst some_1 = __importDefault(require(\"lodash/some\"));\nconst prosemirror_state_1 = require(\"prosemirror-state\");\nconst tableCol_1 = __importDefault(require(\"../menus/tableCol\"));\nconst tableRow_1 = __importDefault(require(\"../menus/tableRow\"));\nconst table_1 = __importDefault(require(\"../menus/table\"));\nconst formatting_1 = __importDefault(require(\"../menus/formatting\"));\nconst image_1 = __importDefault(require(\"../menus/image\"));\nconst divider_1 = __importDefault(require(\"../menus/divider\"));\nconst FloatingToolbar_1 = __importDefault(require(\"./FloatingToolbar\"));\nconst LinkEditor_1 = __importDefault(require(\"./LinkEditor\"));\nconst ToolbarMenu_1 = __importDefault(require(\"./ToolbarMenu\"));\nconst filterExcessSeparators_1 = __importDefault(require(\"../lib/filterExcessSeparators\"));\nconst isMarkActive_1 = __importDefault(require(\"../queries/isMarkActive\"));\nconst getMarkRange_1 = __importDefault(require(\"../queries/getMarkRange\"));\nconst isNodeActive_1 = __importDefault(require(\"../queries/isNodeActive\"));\nconst getColumnIndex_1 = __importDefault(require(\"../queries/getColumnIndex\"));\nconst getRowIndex_1 = __importDefault(require(\"../queries/getRowIndex\"));\nconst createAndInsertLink_1 = __importDefault(require(\"../commands/createAndInsertLink\"));\nfunction isVisible(props) {\n    const { view } = props;\n    const { selection } = view.state;\n    if (!selection)\n        return false;\n    if (selection.empty)\n        return false;\n    if (selection.node && selection.node.type.name === \"hr\") {\n        return true;\n    }\n    if (selection.node && selection.node.type.name === \"image\") {\n        return true;\n    }\n    if (selection.node)\n        return false;\n    const slice = selection.content();\n    const fragment = slice.content;\n    const nodes = fragment.content;\n    return some_1.default(nodes, n => n.content.size);\n}\nclass SelectionToolbar extends React.Component {\n    constructor() {\n        super(...arguments);\n        this.isActive = false;\n        this.menuRef = React.createRef();\n        this.handleClickOutside = (ev) => {\n            if (ev.target instanceof Node &&\n                this.menuRef.current &&\n                this.menuRef.current.contains(ev.target)) {\n                return;\n            }\n            if (!this.isActive) {\n                return;\n            }\n            const { view } = this.props;\n            if (view.hasFocus()) {\n                return;\n            }\n            const { dispatch } = view;\n            dispatch(view.state.tr.setSelection(new prosemirror_state_1.TextSelection(view.state.doc.resolve(0))));\n        };\n        this.handleOnCreateLink = async (title) => {\n            const { dictionary, onCreateLink, view, onShowToast } = this.props;\n            if (!onCreateLink) {\n                return;\n            }\n            const { dispatch, state } = view;\n            const { from, to } = state.selection;\n            if (from === to) {\n                return;\n            }\n            const href = `creating#${title}…`;\n            const markType = state.schema.marks.link;\n            dispatch(view.state.tr\n                .removeMark(from, to, markType)\n                .addMark(from, to, markType.create({ href })));\n            createAndInsertLink_1.default(view, title, href, {\n                onCreateLink,\n                onShowToast,\n                dictionary,\n            });\n        };\n        this.handleOnSelectLink = ({ href, from, to, }) => {\n            const { view } = this.props;\n            const { state, dispatch } = view;\n            const markType = state.schema.marks.link;\n            dispatch(state.tr\n                .removeMark(from, to, markType)\n                .addMark(from, to, markType.create({ href })));\n        };\n    }\n    componentDidUpdate() {\n        const visible = isVisible(this.props);\n        if (this.isActive && !visible) {\n            this.isActive = false;\n            this.props.onClose();\n        }\n        if (!this.isActive && visible) {\n            this.isActive = true;\n            this.props.onOpen();\n        }\n    }\n    componentDidMount() {\n        window.addEventListener(\"mouseup\", this.handleClickOutside);\n    }\n    componentWillUnmount() {\n        window.removeEventListener(\"mouseup\", this.handleClickOutside);\n    }\n    render() {\n        const _a = this.props, { dictionary, onCreateLink, isTemplate, rtl } = _a, rest = __rest(_a, [\"dictionary\", \"onCreateLink\", \"isTemplate\", \"rtl\"]);\n        const { view } = rest;\n        const { state } = view;\n        const { selection } = state;\n        const isCodeSelection = isNodeActive_1.default(state.schema.nodes.code_block)(state);\n        const isDividerSelection = isNodeActive_1.default(state.schema.nodes.hr)(state);\n        if (isCodeSelection) {\n            return null;\n        }\n        const colIndex = getColumnIndex_1.default(state.selection);\n        const rowIndex = getRowIndex_1.default(state.selection);\n        const isTableSelection = colIndex !== undefined && rowIndex !== undefined;\n        const link = isMarkActive_1.default(state.schema.marks.link)(state);\n        const range = getMarkRange_1.default(selection.$from, state.schema.marks.link);\n        const isImageSelection = selection.node && selection.node.type.name === \"image\";\n        let isTextSelection = false;\n        let items = [];\n        if (isTableSelection) {\n            items = table_1.default(dictionary);\n        }\n        else if (colIndex !== undefined) {\n            items = tableCol_1.default(state, colIndex, rtl, dictionary);\n        }\n        else if (rowIndex !== undefined) {\n            items = tableRow_1.default(state, rowIndex, dictionary);\n        }\n        else if (isImageSelection) {\n            items = image_1.default(state, dictionary);\n        }\n        else if (isDividerSelection) {\n            items = divider_1.default(state, dictionary);\n        }\n        else {\n            items = formatting_1.default(state, isTemplate, dictionary);\n            isTextSelection = true;\n        }\n        items = items.filter(item => {\n            if (item.name === \"separator\")\n                return true;\n            if (item.name && !this.props.commands[item.name])\n                return false;\n            return true;\n        });\n        items = filterExcessSeparators_1.default(items);\n        if (!items.length) {\n            return null;\n        }\n        const selectionText = state.doc.cut(state.selection.from, state.selection.to).textContent;\n        if (isTextSelection && !selectionText) {\n            return null;\n        }\n        return (React.createElement(react_portal_1.Portal, null,\n            React.createElement(FloatingToolbar_1.default, { view: view, active: isVisible(this.props), ref: this.menuRef }, link && range ? (React.createElement(LinkEditor_1.default, Object.assign({ dictionary: dictionary, mark: range.mark, from: range.from, to: range.to, onCreateLink: onCreateLink ? this.handleOnCreateLink : undefined, onSelectLink: this.handleOnSelectLink }, rest))) : (React.createElement(ToolbarMenu_1.default, Object.assign({ items: items }, rest))))));\n    }\n}\nexports.default = SelectionToolbar;\n"]},"metadata":{},"sourceType":"script"}